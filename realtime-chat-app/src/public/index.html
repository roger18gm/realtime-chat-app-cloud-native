<!DOCTYPE html>
<html>
  <head>
    <title>Realtime Chat</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }
      .container {
        display: flex;
        height: 100vh;
      }
      .sidebar {
        width: 250px;
        background-color: #2c3e50;
        color: white;
        padding: 1rem;
        overflow-y: auto;
      }
      .sidebar h3 {
        margin-top: 0;
      }
      .room-btn {
        display: block;
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: #34495e;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
      }
      .room-btn:hover {
        background-color: #3d5470;
      }
      .room-btn.active {
        background-color: #3498db;
      }
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 2rem;
      }
      .chat-header {
        margin-bottom: 1rem;
        border-bottom: 2px solid #ccc;
        padding-bottom: 1rem;
      }
      .room-info {
        font-size: 0.9rem;
        color: #666;
      }
      .messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        padding: 1rem;
        background-color: white;
        border-radius: 4px;
      }
      .message {
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background-color: #ecf0f1;
        border-radius: 4px;
      }
      .message.history {
        opacity: 0.8;
        background-color: #dfe6e9;
      }
      .message.system {
        background-color: #fff9e6;
        font-style: italic;
        color: #666;
      }
      .message-user {
        font-weight: bold;
        color: #2c3e50;
      }
      .message-content {
        margin-top: 0.25rem;
        color: #333;
      }
      .input-area {
        display: flex;
        gap: 0.5rem;
      }
      #messageInput {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }
      #sendBtn {
        padding: 0.75rem 1rem;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      #sendBtn:hover {
        background-color: #2980b9;
      }
      .typing-indicator {
        font-size: 0.8rem;
        color: #999;
        font-style: italic;
        margin-top: 0.5rem;
      }
      .auth-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 1000;
      }
      .auth-container.show {
        display: flex;
      }
      .auth-box {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        text-align: center;
      }
      .auth-box h1 {
        margin-top: 0;
        color: #2c3e50;
      }
      .auth-btn {
        display: inline-block;
        padding: 0.75rem 2rem;
        margin: 0.5rem;
        background-color: #3498db;
        color: white;
        text-decoration: none;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
      }
      .auth-btn:hover {
        background-color: #2980b9;
      }
      .auth-btn.logout {
        background-color: #e74c3c;
      }
      .auth-btn.logout:hover {
        background-color: #c0392b;
      }
      .user-info {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.9rem;
        color: #2c3e50;
      }
      .user-info .logout-btn {
        margin-left: 0.5rem;
      }
    </style>
  </head>
  <body>
    <!-- Authentication screen -->
    <div class="auth-container" id="authContainer">
      <div class="auth-box">
        <h1>Realtime Chat</h1>
        <p>Sign in to access the chat</p>
        <a href="/login" class="auth-btn">Sign In with Cognito</a>
      </div>
    </div>

    <!-- Main chat interface -->
    <div class="container" id="chatContainer" style="display: none">
      <div class="user-info" id="userInfo"></div>
      <div class="sidebar">
        <h3>Rooms</h3>
        <button class="room-btn active" data-room="general">general</button>
        <button class="room-btn" data-room="engineering">engineering</button>
        <button class="room-btn" data-room="random">random</button>
      </div>

      <div class="main">
        <div class="chat-header">
          <h2 id="currentRoom">general</h2>
          <div class="room-info">
            Users online: <span id="userCount">0</span>
          </div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="typing-indicator" id="typingIndicator"></div>

        <div class="input-area">
          <input
            type="text"
            id="messageInput"
            placeholder="Type a message..."
            autocomplete="off"
          />
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // ===== Authentication Management =====

      let authToken = null;
      let currentUser = null;

      /**
       * Extract token from URL query parameters (after Cognito redirect)
       */
      function getTokenFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("token") || localStorage.getItem("authToken");
      }

      /**
       * Fetch user info from /api/auth/me endpoint
       */
      async function fetchUserInfo(token) {
        try {
          const response = await fetch("/api/auth/me", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          if (response.ok) {
            return await response.json();
          }
          return null;
        } catch (error) {
          console.error("Failed to fetch user info:", error);
          return null;
        }
      }

      /**
       * Initialize authentication
       */
      async function initializeAuth() {
        const authContainer = document.getElementById("authContainer");
        const chatContainer = document.getElementById("chatContainer");
        const userInfoEl = document.getElementById("userInfo");

        // Try to get token from URL or localStorage
        authToken = getTokenFromUrl();

        if (authToken) {
          // Verify token by fetching user info
          const userInfo = await fetchUserInfo(authToken);
          if (userInfo) {
            currentUser = userInfo;
            localStorage.setItem("authToken", authToken);

            // Remove token from URL
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname
            );

            // Show chat, hide auth
            authContainer.classList.remove("show");
            chatContainer.style.display = "flex";
            userInfoEl.innerHTML = `
              <span>${currentUser.email}</span>
              <a href="/logout" class="logout-btn">Logout</a>
            `;

            // Initialize chat
            initializeChat();
            return;
          }
        }

        // No valid token, show login screen
        authContainer.classList.add("show");
        chatContainer.style.display = "none";
      }

      /**
       * Initialize chat only after authentication
       */
      function initializeChat() {
        // Initialize Socket.IO with token
        const socket = io({
          auth: {
            token: authToken,
          },
        });

        const messagesDiv = document.getElementById("messages");
        const messageInput = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");
        const currentRoomDisplay = document.getElementById("currentRoom");
        const userCountDisplay = document.getElementById("userCount");
        const typingIndicatorDiv = document.getElementById("typingIndicator");
        const roomBtns = document.querySelectorAll(".room-btn");

        let currentRoom = "general";
        let typingUsers = new Set();
        let typingTimeout;

        // Handle socket connection errors
        socket.on("connect_error", (error) => {
          console.error("Socket connection error:", error.message);
          if (error.message.includes("Unauthorized")) {
            // Token expired or invalid, redirect to login
            localStorage.removeItem("authToken");
            window.location.href = "/login";
          }
        });

        // Join default room on connect
        socket.on("connect", () => {
          socket.emit("room:join", currentRoom);
        });

        // Handle room join
        socket.on("room:users", (data) => {
          messagesDiv.innerHTML = "";
          typingUsers.clear();

          typingIndicatorDiv.textContent = "";
          currentRoom = data.roomId;
          currentRoomDisplay.textContent = currentRoom;
          userCountDisplay.textContent = data.userCount;
        });

        // Handle message history
        socket.on("room:history", (data) => {
          // Add historical messages to the display
          if (data.messages && data.messages.length > 0) {
            data.messages.forEach((message) => {
              addMessage(message.displayName, message.content, true);
            });
          }
        });

        // Handle user joined
        socket.on("room:user-joined", (data) => {
          addSystemMessage(
            `${data.displayName} joined (${data.userCount} online)`
          );
          userCountDisplay.textContent = data.userCount;
        });

        // Handle user left
        socket.on("room:user-left", (data) => {
          addSystemMessage(
            `${data.displayName} left (${data.userCount} online)`
          );
          userCountDisplay.textContent = data.userCount;
        });

        // Handle new message
        socket.on("message:new", (message) => {
          addMessage(message.displayName, message.content);
          typingUsers.delete(message.userId);
          updateTypingIndicator();
        });

        // Handle typing started
        socket.on("typing:started", (data) => {
          typingUsers.add(data.userId);
          updateTypingIndicator();
        });

        // Handle typing stopped
        socket.on("typing:stopped", (data) => {
          typingUsers.delete(data.userId);
          updateTypingIndicator();
        });

        // Room button clicks
        roomBtns.forEach((btn) => {
          btn.addEventListener("click", () => {
            const roomId = btn.dataset.room;
            socket.emit("room:leave", currentRoom);
            socket.emit("room:join", roomId);

            roomBtns.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
          });
        });

        // Send message
        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") sendMessage();
        });

        // Typing indicators
        messageInput.addEventListener("input", () => {
          socket.emit("typing:start");
          clearTimeout(typingTimeout);
          typingTimeout = setTimeout(() => {
            socket.emit("typing:stop");
          }, 3000);
        });

        function sendMessage() {
          const content = messageInput.value.trim();
          if (content) {
            socket.emit("message:send", { content });
            messageInput.value = "";
            socket.emit("typing:stop");
          }
        }

        function addMessage(user, content, isHistory = false) {
          const messageEl = document.createElement("div");
          messageEl.className = "message" + (isHistory ? " history" : "");
          messageEl.innerHTML = `
          <div class="message-user">${user}</div>
          <div class="message-content">${escapeHtml(content)}</div>
        `;
          messagesDiv.appendChild(messageEl);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addSystemMessage(content) {
          const messageEl = document.createElement("div");
          messageEl.className = "message system";
          messageEl.textContent = content;
          messagesDiv.appendChild(messageEl);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateTypingIndicator() {
          if (typingUsers.size > 0) {
            const users = Array.from(typingUsers).join(", ");
            typingIndicatorDiv.textContent = `${users} ${
              typingUsers.size === 1 ? "is" : "are"
            } typing...`;
          } else {
            typingIndicatorDiv.textContent = "";
          }
        }

        function escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }
      }

      // ===== Initialize on Page Load =====
      document.addEventListener("DOMContentLoaded", initializeAuth);
    </script>
  </body>
</html>
