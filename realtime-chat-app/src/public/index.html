<!DOCTYPE html>
<html>
  <head>
    <title>Realtime Chat</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }
      .container {
        display: flex;
        height: 100vh;
      }
      .sidebar {
        width: 250px;
        background-color: #2c3e50;
        color: white;
        padding: 1rem;
        overflow-y: auto;
      }
      .sidebar h3 {
        margin-top: 0;
      }
      .room-btn {
        display: block;
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: #34495e;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
      }
      .room-btn:hover {
        background-color: #3d5470;
      }
      .room-btn.active {
        background-color: #3498db;
      }
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 2rem;
      }
      .chat-header {
        margin-bottom: 1rem;
        border-bottom: 2px solid #ccc;
        padding-bottom: 1rem;
      }
      .room-info {
        font-size: 0.9rem;
        color: #666;
      }
      .messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        padding: 1rem;
        background-color: white;
        border-radius: 4px;
      }
      .message {
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background-color: #ecf0f1;
        border-radius: 4px;
      }
      .message.history {
        opacity: 0.8;
        background-color: #dfe6e9;
      }
      .message.system {
        background-color: #fff9e6;
        font-style: italic;
        color: #666;
      }
      .message-user {
        font-weight: bold;
        color: #2c3e50;
      }
      .message-content {
        margin-top: 0.25rem;
        color: #333;
      }
      .input-area {
        display: flex;
        gap: 0.5rem;
      }
      #messageInput {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }
      #sendBtn {
        padding: 0.75rem 1rem;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      #sendBtn:hover {
        background-color: #2980b9;
      }
      .typing-indicator {
        font-size: 0.8rem;
        color: #999;
        font-style: italic;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <h3>Rooms</h3>
        <button class="room-btn active" data-room="general">general</button>
        <button class="room-btn" data-room="engineering">engineering</button>
        <button class="room-btn" data-room="random">random</button>
      </div>

      <div class="main">
        <div class="chat-header">
          <h2 id="currentRoom">general</h2>
          <div class="room-info">
            Users online: <span id="userCount">0</span>
          </div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="typing-indicator" id="typingIndicator"></div>

        <div class="input-area">
          <input
            type="text"
            id="messageInput"
            placeholder="Type a message..."
            autocomplete="off"
          />
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const messagesDiv = document.getElementById("messages");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const currentRoomDisplay = document.getElementById("currentRoom");
      const userCountDisplay = document.getElementById("userCount");
      const typingIndicatorDiv = document.getElementById("typingIndicator");
      const roomBtns = document.querySelectorAll(".room-btn");

      let currentRoom = "general";
      let typingUsers = new Set();
      let typingTimeout;

      // Join default room on connect
      socket.on("connect", () => {
        socket.emit("room:join", currentRoom);
      });

      // Handle room join
      socket.on("room:users", (data) => {
        messagesDiv.innerHTML = "";
        typingUsers.clear();
        typingIndicatorDiv.textContent = "";
        currentRoom = data.roomId;
        currentRoomDisplay.textContent = currentRoom;
        userCountDisplay.textContent = data.userCount;
      });

      // Handle message history
      socket.on("room:history", (data) => {
        // Add historical messages to the display
        if (data.messages && data.messages.length > 0) {
          data.messages.forEach((message) => {
            addMessage(message.displayName, message.content, true);
          });
        }
      });

      // Handle user joined
      socket.on("room:user-joined", (data) => {
        addSystemMessage(
          `${data.displayName} joined (${data.userCount} online)`
        );
        userCountDisplay.textContent = data.userCount;
      });

      // Handle user left
      socket.on("room:user-left", (data) => {
        addSystemMessage(`${data.displayName} left (${data.userCount} online)`);
        userCountDisplay.textContent = data.userCount;
      });

      // Handle new message
      socket.on("message:new", (message) => {
        addMessage(message.displayName, message.content);
        typingUsers.delete(message.userId);
        updateTypingIndicator();
      });

      // Handle typing started
      socket.on("typing:started", (data) => {
        typingUsers.add(data.userId);
        updateTypingIndicator();
      });

      // Handle typing stopped
      socket.on("typing:stopped", (data) => {
        typingUsers.delete(data.userId);
        updateTypingIndicator();
      });

      // Room button clicks
      roomBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const roomId = btn.dataset.room;
          socket.emit("room:leave", currentRoom);
          socket.emit("room:join", roomId);

          roomBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      // Send message
      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // Typing indicators
      messageInput.addEventListener("input", () => {
        socket.emit("typing:start");
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit("typing:stop");
        }, 3000);
      });

      function sendMessage() {
        const content = messageInput.value.trim();
        if (content) {
          socket.emit("message:send", { content });
          messageInput.value = "";
          socket.emit("typing:stop");
        }
      }

      function addMessage(user, content, isHistory = false) {
        const messageEl = document.createElement("div");
        messageEl.className = "message" + (isHistory ? " history" : "");
        messageEl.innerHTML = `
          <div class="message-user">${user}</div>
          <div class="message-content">${escapeHtml(content)}</div>
        `;
        messagesDiv.appendChild(messageEl);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addSystemMessage(content) {
        const messageEl = document.createElement("div");
        messageEl.className = "message system";
        messageEl.textContent = content;
        messagesDiv.appendChild(messageEl);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function updateTypingIndicator() {
        if (typingUsers.size > 0) {
          const users = Array.from(typingUsers).join(", ");
          typingIndicatorDiv.textContent = `${users} ${
            typingUsers.size === 1 ? "is" : "are"
          } typing...`;
        } else {
          typingIndicatorDiv.textContent = "";
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
